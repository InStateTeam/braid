<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Hermes</title>
  <link rel="stylesheet" href="/app.css">
  <script src="/vendor.js"></script>
  <script src="/app.js"></script>
  <script>require('initialize');</script>
</head>
<body>
<header>
  <span>Hermes</span>
</header>
<main>
  <section class="endpoint">
    <div>
      <label for="url">End Point</label>
      <span id="url"></span>
    </div>
  </section>
  <section id="container">
    <aside class="services-list">
      <ul id="services">
      </ul>
    </aside>                           
    <div id="editor">
      <section class="functions">
        <button id="deleteBtn">Delete</button>
        <input type="text" id="newService">
        <button id="createServiceBtn">Create</button>
        <button id="saveBtn">Save</button>
        <button id="formatBtn">Format</button>
      </section>
      <section id="monaco"></section>     
    </div>
  </section>
</main>
<footer>

</footer>

<script src="monaco-editor/min/vs/loader.js"></script>
<script>
   $.delete = function(url, callback){
    return $.ajax({
      url: url,
      method: 'DELETE',
      success: callback
    });
  }

    var editor;
    var selectedService;

    $(document).ready(function() {
      init();
    })

    function init() {
      getEndPoint();
      bindEvents();
      loadEditor();
    }

    function bindEvents() {
      $('#saveBtn').click(onSave);
      $('#formatBtn').click(onFormat);
      $('#createServiceBtn').click(onCreateService);
      $('#deleteBtn').click(onDelete);
    }

    function onSave(e) {
      const script = editor.getValue()
      const service = getSelectedService()

      $.post("/api/services/" + service + "/script", script)
        .done(function() {
          console.log("saved")
          $('#saveBtn').prop('disabled', true)
        })
        .fail(function(e) {
          console.log("failed to save", e);
        })
    }

    function onFormat(e) {
      editor.trigger('', 'editor.action.formatDocument');
    }

    function onCreateService() {
      const serviceName = $('#newService').val()
      getServiceScript(serviceName, function() {
        retrieveAndUpdateServices(serviceName);
        $('#newService').val("");
      })
   }

    function onDelete(e){
      const serviceName = selectedService;
      const callValue = "/api/services/" + serviceName;
      $.delete(callValue, function(){
        retrieveAndUpdateServices();
      });
    }

    function populateServiceOptions(selection, services) {
      selection.empty();

      for (var idx in services) {
        const service = services[idx];
        const option = $('<li>', {value: service, text: service})
        option.click(onServiceSelect);
        selection.append(option);
      }
    }

    function updateServices(services, selectedService) {
      const selection = $('#services');
      populateServiceOptions(selection, services);
      if (selectedService === null && services.length > 0) {
        selectedService = services[0];
        initHighlight(selectedService);
      }
      if (selectedService) {
        selection.val(selectedService).trigger('change');
        window.selectedService = selectedService;
        getServiceScript(selectedService, function(script) {
          setEditorContents(script)
          $('#saveBtn').prop('disabled', true)
        });
        getJavaHeaders(selectedService, function(script) {
          // TODO: put this stuff somewhere in the UI
        });
        highlightNewService(selectedService);
       }
    }

    function onServiceSelect(e) {
      selectedService = this.textContent
      getServiceScript(selectedService, function(script) {
        setEditorContents(script)
        $('#saveBtn').prop('disabled', true)
      });
      getJavaHeaders(selectedService, function(script) {
        // TODO: put this stuff somewhere in the UI
      });
      selectHighlight(e);
      getEndPoint();
    }

    function getSelectedService() {
      return selectedService;
    }    

    function setEditorContents(script) {
      editor.setValue(script)
    }

    function getServiceScript(serviceName, callback) {
      $.get("/api/services/" + serviceName + "/script", function(script) {
        callback(script)
      })
    }

    function getJavaHeaders(serviceName, callback) {
      $.get("/api/services/" + serviceName + "/java", function(script) {
        callback(script);
      });
    }

    function ensureServiceIsCreated(callback) {
      const params = parseURL(document.URL).searchObject
      if (typeof(params['service']) !== 'undefined' && params.service !== null) {
        getServiceScript(params.service, function() {
          callback(params.service)
        })
      } else {
        callback(null)
      }
    }

    function retrieveAndUpdateServices(selectdService) {
      $.get("/api/services", function (data) {
        updateServices(data, selectedService);
        loadMonaco();
      });
    }

    function onScriptChanged() {
      $('#saveBtn').prop('disabled', false);
    }

    function loadEditor() {
      ensureServiceIsCreated(function(selectedService) {
          retrieveAndUpdateServices(selectedService);
      })
     }

     function loadMonaco(){
      require.config({ paths: { 'vs': 'monaco-editor/min/vs' }});
      require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('monaco'), {
          value: "",
          language: 'javascript',
          automaticLayout: true

        });
        editor.onDidChangeModelContent(onScriptChanged);        
      });
     }

    function parseURL(url) {
      var parser = document.createElement('a'),
        searchObject = {},
        queries, split, i;
      // Let the browser do the work
      parser.href = url;
      // Convert query string to object
      queries = parser.search.replace(/^\?/, '').split('&');
      for( i = 0; i < queries.length; i++ ) {
        split = queries[i].split('=');
        searchObject[split[0]] = split[1];
      }
      return {
        protocol: parser.protocol,
        host: parser.host,
        hostname: parser.hostname,
        port: parser.port,
        pathname: parser.pathname,
        search: parser.search,
        searchObject: searchObject,
        hash: parser.hash
      };
    }

   function selectHighlight(e){
     const lists = document.querySelector('#services').querySelectorAll('li');
     for (let item = 0; item < lists.length; item++) {
       lists[item].style.background = '#1973E2';
     }
     e.target.style.background = "#0E3A70"
   }

   function highlightNewService(selectedService){
     const lists = document.querySelector('#services').querySelectorAll('li');
     let newServiceIndex = "";
     for (let item = 0; item < lists.length;  item++) {
       lists[item].style.background = '#1973E2';
       if(lists[item].innerText === selectedService){
         newServiceIndex = item;
       }
     }

     if(newServiceIndex){
       lists[newServiceIndex].style.background = "#0E3A70";
     }
   }

   function initHighlight(selectedService){
     const item = document.querySelector('#services').querySelector('li');
     item.style.background = '#1973E2';
   }

   function getEndPoint(){
     const host = window.location.host;
     const service = (selectedService) ? selectedService : "";
     document.querySelector('#url').innerHTML = "ws://" + host + "/api/services/" + service;

   }
</script>
</body>
